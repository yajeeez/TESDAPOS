<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Debug Console</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; }
        .debug-section { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .image-test { margin: 10px 0; }
        img { max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; }
        .info { color: blue; background: #e6f3ff; padding: 10px; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .console-output { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .product-card { display: inline-block; margin: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Image Debug Console</h1>
    
    <div class="debug-panel">
        <h2>Quick Actions</h2>
        <button onclick="testAllImages()">Test All Images</button>
        <button onclick="refreshAllImages()">Refresh All Images</button>
        <button onclick="testProduct1()">Test Product 1</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div class="debug-panel">
        <h2>Console Output</h2>
        <div id="consoleOutput" class="console-output">Ready for testing...\n</div>
    </div>
    
    <div class="debug-panel">
        <h2>Current Product Images</h2>
        <div id="productImages"></div>
    </div>
    
    <div class="debug-panel">
        <h2>API Test Results</h2>
        <div id="apiResults"></div>
    </div>

    <script>
        // Console logging function
        function log(message) {
            const console = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').textContent = 'Console cleared...\n';
        }
        
        // Test functions
        async function testAllImages() {
            log('=== Testing All Images ===');
            
            try {
                const response = await fetch('http://localhost/TESDAPOS/admin/list_images.php');
                const data = await response.json();
                
                if (data.success) {
                    log(`Found ${data.images.length} images total`);
                    
                    // Group by product ID
                    const productGroups = {};
                    data.images.forEach(img => {
                        const match = img.filename.match(/product_(\d+)_/);
                        if (match) {
                            const productId = match[1];
                            if (!productGroups[productId]) {
                                productGroups[productId] = [];
                            }
                            productGroups[productId].push(img);
                        }
                    });
                    
                    log(`Images grouped by product: ${Object.keys(productGroups).length} products`);
                    
                    // Display each product's images
                    const productImagesDiv = document.getElementById('productImages');
                    productImagesDiv.innerHTML = '';
                    
                    Object.keys(productGroups).forEach(productId => {
                        const images = productGroups[productId];
                        images.sort((a, b) => b.modified - a.modified);
                        
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product-card';
                        productDiv.innerHTML = `
                            <h3>Product ${productId}</h3>
                            <p>Latest: ${images[0].filename}</p>
                            <p>Modified: ${new Date(images[0].modified * 1000).toLocaleString()}</p>
                            <img src="${images[0].path}" alt="Latest Image" onerror="this.style.border='3px solid red'; this.alt='FAILED TO LOAD'">
                            <p>Path: ${images[0].path}</p>
                        `;
                        productImagesDiv.appendChild(productDiv);
                        
                        log(`Product ${productId}: ${images.length} images, latest is ${images[0].filename}`);
                    });
                    
                } else {
                    log('API returned success: false');
                }
                
            } catch (error) {
                log(`Error: ${error.message}`);
            }
        }
        
        async function refreshAllImages() {
            log('=== Refreshing All Images ===');
            
            try {
                const response = await fetch('http://localhost/TESDAPOS/admin/list_images.php');
                const data = await response.json();
                
                if (data.success && data.images.length > 0) {
                    log(`Refreshing ${data.images.length} images...`);
                    
                    // Test image loading for each image
                    let loadedCount = 0;
                    let failedCount = 0;
                    
                    for (const img of data.images) {
                        try {
                            const imgResponse = await fetch(`http://localhost/TESDAPOS/${img.path}`);
                            if (imgResponse.ok) {
                                loadedCount++;
                                log(`âœ“ ${img.filename} - OK`);
                            } else {
                                failedCount++;
                                log(`âœ— ${img.filename} - HTTP ${imgResponse.status}`);
                            }
                        } catch (error) {
                            failedCount++;
                            log(`âœ— ${img.filename} - Error: ${error.message}`);
                        }
                    }
                    
                    log(`Image refresh complete: ${loadedCount} loaded, ${failedCount} failed`);
                    
                } else {
                    log('No images found to refresh');
                }
                
            } catch (error) {
                log(`Refresh error: ${error.message}`);
            }
        }
        
        async function testProduct1() {
            log('=== Testing Product 1 Specifically ===');
            
            try {
                const response = await fetch('http://localhost/TESDAPOS/admin/list_images.php');
                const data = await response.json();
                
                if (data.success && data.images.length > 0) {
                    const product1Images = data.images.filter(img => 
                        img.filename.startsWith('product_1_')
                    );
                    
                    if (product1Images.length > 0) {
                        product1Images.sort((a, b) => b.modified - a.modified);
                        const latest = product1Images[0];
                        
                        log(`Product 1 has ${product1Images.length} images`);
                        log(`Latest: ${latest.filename}`);
                        log(`Path: ${latest.path}`);
                        log(`Full URL: http://localhost/TESDAPOS/${latest.path}`);
                        
                        // Test if image loads
                        const img = new Image();
                        img.onload = () => {
                            log(`âœ“ Image loads successfully: ${latest.filename}`);
                        };
                        img.onerror = () => {
                            log(`âœ— Image failed to load: ${latest.filename}`);
                        };
                        img.src = `http://localhost/TESDAPOS/${latest.path}`;
                        
                    } else {
                        log('No images found for Product 1');
                    }
                }
                
            } catch (error) {
                log(`Product 1 test error: ${error.message}`);
            }
        }
        
        // Auto-run tests on page load
        window.onload = function() {
            log('Debug console loaded. Click buttons to test image functionality.');
            setTimeout(testAllImages, 1000);
        };
    </script>
</body>
</html>
